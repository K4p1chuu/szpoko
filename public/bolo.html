<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poszukiwania (BOLO) - MDT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .details-grid { display: grid; grid-template-columns: 180px 1fr; gap: 4px; }
        .autocomplete-suggestions { max-height: 150px; }
        .modal-backdrop { display: none; }
        .modal-backdrop.flex { display: flex; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex h-screen">

    <aside id="sidebar-container" class="w-64 bg-gray-800 p-4 flex flex-col min-h-screen flex-shrink-0"></aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <h1 class="text-3xl font-bold text-white mb-6">System Poszukiwań (BOLO)</h1>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg self-start">
                <h2 class="text-xl font-semibold text-white mb-4">Wystaw Nowy List Gończy</h2>
                <form id="bolo-form" class="space-y-4 text-sm">
                    <div>
                        <label for="boloType" class="block text-sm font-medium text-gray-400">Typ poszukiwania</label>
                        <select id="boloType" class="mt-1 w-full bg-gray-700 rounded p-2">
                            <option value="Pojazd">Pojazd</option>
                            <option value="Osoba">Osoba</option>
                        </select>
                    </div>
                    <div id="bolo-fields-container" class="space-y-3"></div>
                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Wystaw BOLO</button>
                    <p id="form-message" class="text-center h-4 mt-2"></p>
                </form>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4">Aktywne Listy Gończe</h2>
                <div id="bolo-list" class="space-y-3 max-h-[70vh] overflow-y-auto">
                    <p class="text-gray-500">Ładowanie...</p>
                </div>
            </div>

        </div>
    </main>
    
    <!-- Modal Potwierdzenia Usunięcia -->
    <div id="confirm-modal" class="modal-backdrop fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 z-50 justify-center items-center">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <h3 id="confirm-modal-title" class="text-lg font-medium leading-6 text-white">Potwierdź akcję</h3>
            <p id="confirm-modal-text" class="mt-2 text-sm text-gray-400">Czy na pewno chcesz kontynuować?</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" id="confirm-cancel-button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Anuluj</button>
                <button type="button" id="confirm-danger-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Potwierdź</button>
            </div>
        </div>
    </div>
    
    <script src="shared.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const userData = await loadSidebarAndUserData('bolo');
        if(!userData) return;
        
        const token = localStorage.getItem('mdt-token');
        const boloTypeSelect = document.getElementById('boloType');
        const boloFieldsContainer = document.getElementById('bolo-fields-container');
        const boloList = document.getElementById('bolo-list');
        const boloForm = document.getElementById('bolo-form');
        const formMessage = document.getElementById('form-message');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmCancelButton = document.getElementById('confirm-cancel-button');
        const confirmDangerButton = document.getElementById('confirm-danger-button');
        let actionToConfirm = null;
        
        let allCitizens = [];

        const vehicleFields = `
            <input type="text" name="marka" placeholder="Marka" class="w-full bg-gray-700 rounded p-2" required>
            <input type="text" name="model" placeholder="Model" class="w-full bg-gray-700 rounded p-2" required>
            <input type="text" name="typPojazdu" placeholder="Typ pojazdu" class="w-full bg-gray-700 rounded p-2" required>
            <input type="text" name="trim" placeholder="Trim (opcjonalnie)" class="w-full bg-gray-700 rounded p-2">
            <input type="text" name="rejestracja" placeholder="Numery rejestracyjne" class="w-full bg-gray-700 rounded p-2" required>
            <input type="text" name="stanRejestracji" placeholder="Stan rejestracji" class="w-full bg-gray-700 rounded p-2" required>
            <input type="text" name="kolor" placeholder="Kolor pojazdu" class="w-full bg-gray-700 rounded p-2" required>
            <textarea name="cechy" placeholder="Cechy szczególne (felgi, naklejki...)" class="w-full bg-gray-700 rounded p-2 h-20 resize-none"></textarea>
            <div class="relative"><input type="text" name="kierowca" placeholder="Kierowca (zacznij pisać)" class="w-full bg-gray-700 rounded p-2 autocomplete-input"> <div class="autocomplete-suggestions absolute w-full bg-gray-600 rounded-b-md overflow-y-auto z-10 border-t border-gray-500 hidden"></div></div>
            <div class="relative"><input type="text" name="wlasciciel" placeholder="Właściciel/e (zacznij pisać)" class="w-full bg-gray-700 rounded p-2 autocomplete-input"> <div class="autocomplete-suggestions absolute w-full bg-gray-600 rounded-b-md overflow-y-auto z-10 border-t border-gray-500 hidden"></div></div>
            <input type="text" name="powod" placeholder="Powód poszukiwania" class="w-full bg-gray-700 rounded p-2" required>
        `;

        const personFields = `
            <div class="relative"><input type="text" name="osoba" placeholder="Osoba poszukiwana (zacznij pisać)" class="w-full bg-gray-700 rounded p-2 autocomplete-input" required> <div class="autocomplete-suggestions absolute w-full bg-gray-600 rounded-b-md overflow-y-auto z-10 border-t border-gray-500 hidden"></div></div>
            <textarea name="ubior" placeholder="Ubiór" class="w-full bg-gray-700 rounded p-2 h-20 resize-none" required></textarea>
            <input type="text" name="rysy" placeholder="Rysy twarzy (minka postaci)" class="w-full bg-gray-700 rounded p-2" required>
            <input type="text" name="skora" placeholder="Kolor skóry" class="w-full bg-gray-700 rounded p-2" required>
            <input type="text" name="wlosy" placeholder="Kolor i ułożenie włosów" class="w-full bg-gray-700 rounded p-2" required>
            <textarea name="cechy" placeholder="Cechy charakterystyczne" class="w-full bg-gray-700 rounded p-2 h-20 resize-none"></textarea>
            <input type="text" name="powod" placeholder="Powód poszukiwania" class="w-full bg-gray-700 rounded p-2" required>
        `;

        function updateBoloForm() {
            boloFieldsContainer.innerHTML = boloTypeSelect.value === 'Pojazd' ? vehicleFields : personFields;
            attachAutocompleteListeners();
        }

        function attachAutocompleteListeners() {
            document.querySelectorAll('.autocomplete-input').forEach(input => {
                const suggestionsContainer = input.nextElementSibling;
                input.addEventListener('input', () => {
                    const query = input.value.toLowerCase();
                    if (query.length < 2) {
                        suggestionsContainer.classList.add('hidden');
                        return;
                    }
                    const filtered = allCitizens.filter(c => c.name && c.name.toLowerCase().includes(query));
                    suggestionsContainer.innerHTML = '';
                    if (filtered.length > 0) {
                        filtered.slice(0, 5).forEach(citizen => {
                            const div = document.createElement('div');
                            div.className = 'p-2 hover:bg-gray-500 cursor-pointer text-sm';
                            div.textContent = `${citizen.name} (${citizen.discordId})`;
                            div.addEventListener('click', () => {
                                input.value = `${citizen.name} (<@${citizen.discordId}>)`;
                                suggestionsContainer.classList.add('hidden');
                            });
                            suggestionsContainer.appendChild(div);
                        });
                        suggestionsContainer.classList.remove('hidden');
                    } else {
                        suggestionsContainer.classList.add('hidden');
                    }
                });
                 document.addEventListener('click', (e) => {
                    if (!e.target.closest('.relative')) {
                       suggestionsContainer.classList.add('hidden');
                    }
                });
            });
        }
        
        async function fetchCitizens() {
            try {
                const response = await fetch('/api/citizens', { headers: { 'Authorization': token } });
                if (!response.ok) { 
                    allCitizens = [];
                    return;
                }
                allCitizens = await response.json();
            } catch (error) { console.error("Błąd ładowania obywateli:", error); }
        }

        async function fetchBolo() {
            try {
                boloList.innerHTML = '<p class="text-gray-500">Ładowanie...</p>';
                const response = await fetch('/api/bolo', { headers: { 'Authorization': token } });
                
                if (!response.ok) {
                    if (response.headers.get("content-type")?.includes("application/json")) {
                        const err = await response.json();
                        throw new Error(err.message || `Serwer odpowiedział: ${response.status}`);
                    }
                    const errorText = await response.text();
                    console.error("Raw error response:", errorText);
                    throw new Error(`Serwer odpowiedział statusem ${response.status}. Sprawdź konsolę.`);
                }
                
                const bolos = await response.json();
                boloList.innerHTML = '';
                if (!bolos || bolos.length === 0) {
                    boloList.innerHTML = '<p class="text-gray-500">Brak aktywnych listów gończych.</p>';
                    return;
                }
                bolos.forEach(bolo => {
                    const details = bolo.details || {};
                    const summary = bolo.type === 'Pojazd' 
                        ? `[POJAZD] ${details.marka || 'Brak marki'} ${details.model || 'Brak modelu'}` 
                        : `[OSOBA] ${details.osoba || 'Brak danych osoby'}`;

                    let detailsHtml = '';
                    Object.entries(details).forEach(([key, value]) => {
                        if(value) {
                            const formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim();
                            detailsHtml += `<div class="details-grid"><span class="font-semibold text-gray-400">${formattedKey}:</span><span>${value}</span></div>`;
                        }
                    });

                    // Formatowanie daty
                    const formattedDate = bolo.createdAt 
                        ? new Date(bolo.createdAt).toLocaleString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                        : 'Brak daty';

                    const boloElement = document.createElement('div');
                    boloElement.className = 'bg-gray-900 p-3 rounded-lg text-sm';
                    boloElement.innerHTML = `
                        <div class="flex justify-between items-center cursor-pointer" data-bolo-id="${bolo.id}">
                            <div>
                                <p class="font-bold text-base">${summary}</p>
                                <p class="text-xs text-gray-400">Powód: ${details.powod || 'Nie podano'}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    Wystawione przez: ${bolo.author} (${bolo.authorBadge})
                                    <span class="ml-2 text-gray-600">${formattedDate}</span>
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                 ${(userData.isAdmin || userData.badge === '101') ? `<button data-delete-id="${bolo.id}" class="delete-bolo-btn text-red-500 hover:text-red-400 p-1"><i data-lucide="x-circle" class="w-4 h-4 pointer-events-none"></i></button>` : ''}
                                <i data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>
                            </div>
                        </div>
                        <div class="details hidden mt-3 pt-3 border-t border-gray-700 space-y-1 text-xs">
                            ${detailsHtml}
                        </div>
                    `;
                    boloList.appendChild(boloElement);
                });
                lucide.createIcons();
            } catch (error) {
                console.error("Błąd ładowania BOLO:", error);
                boloList.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        }

        function showConfirmModal(text, onConfirm) {
            confirmModalText.textContent = text;
            actionToConfirm = onConfirm;
            confirmModal.classList.add('flex');
        }

        confirmCancelButton.addEventListener('click', () => {
            confirmModal.classList.remove('flex');
            actionToConfirm = null;
        });

        confirmDangerButton.addEventListener('click', () => {
            if (typeof actionToConfirm === 'function') {
                actionToConfirm();
            }
            confirmModal.classList.remove('flex');
            actionToConfirm = null;
        });

        boloForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            formMessage.textContent = 'Wysyłanie...';
            
            const formData = new FormData(boloForm);
            const details = Object.fromEntries(formData.entries());
            const boloData = {
                type: boloTypeSelect.value,
                details: details
            };
            
            try {
                const response = await fetch('/api/bolo', {
                    method: 'POST',
                    headers: { 'Authorization': token, 'Content-Type': 'application/json' },
                    body: JSON.stringify(boloData)
                });
                
                const result = await response.json(); 
                if (!response.ok) {
                    throw new Error(result.message || 'Błąd serwera. Sprawdź konsolę.');
                }
                
                formMessage.textContent = 'Wystawiono pomyślnie!';
                boloForm.reset();
                updateBoloForm();
                await fetchBolo();
                setTimeout(() => formMessage.textContent = '', 3000);
            } catch (error) {
                if (error instanceof SyntaxError && error.message.includes("Unexpected token '<'")) {
                    formMessage.textContent = "Błąd: Serwer zwrócił stronę HTML zamiast JSON. Sprawdź błędy serwera.";
                } else {
                    formMessage.textContent = `Błąd: ${error.message}`;
                }
                console.error('Błąd wystawiania BOLO:', error);
            }
        });
        
        boloList.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-bolo-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.deleteId;
                showConfirmModal('Czy na pewno chcesz usunąć ten list gończy?', async () => {
                    try {
                        const response = await fetch(`/api/bolo/${id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': token }
                        });
                        
                        if (!response.ok) {
                            // Spróbuj odczytać wiadomość o błędzie z JSON
                            const errorData = await response.json().catch(() => ({ message: 'Błąd serwera' }));
                            throw new Error(errorData.message);
                        }
                        await fetchBolo();
                    } catch (error) {
                        alert(`Nie udało się usunąć BOLO: ${error.message}`);
                    }
                });
                return; 
            }

            const header = e.target.closest('[data-bolo-id]');
            if (header) {
                const details = header.nextElementSibling;
                const icon = header.querySelector('[data-lucide="chevron-down"]');
                details.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            }
        });
        
        boloTypeSelect.addEventListener('change', updateBoloForm);
        
        // Initialization
        updateBoloForm();
        await fetchCitizens();
        await fetchBolo();
    });
    </script>
</body>
</html>

