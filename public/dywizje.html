<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dywizje - WSP & OCSO MDT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .fira-code { font-family: 'Fira Code', monospace; }
        .division-title { color: #60a5fa; }
        .division-lead { color: #facc15; }
        .division-members { color: #a78bfa; }
        .modal-backdrop { display: none; }
        .modal-backdrop.flex { display: flex; }
        .dept-btn.active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex h-screen">

    <aside id="sidebar-container" class="w-64 bg-gray-800 p-4 flex flex-col min-h-screen flex-shrink-0"></aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <h1 class="text-3xl font-bold text-white mb-6">Dywizje Departamentów</h1>

        <div class="mb-6 flex justify-center gap-4">
            <button id="wsp-btn" class="dept-btn active bg-gray-700 hover:bg-gray-600 font-bold py-2 px-6 rounded-lg transition-colors">WSP</button>
            <button id="ocso-btn" class="dept-btn bg-gray-700 hover:bg-gray-600 font-bold py-2 px-6 rounded-lg transition-colors">OCSO</button>
        </div>

        <div id="wsp-divisions" class="division-content">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
                <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Opis Dywizji WSP</h2>
                <div class="space-y-4 text-gray-300">
                    <p><b class="division-title">Dywizja Patrolowa</b> - Podstawowa dywizja.</p>
                    <p><b class="division-title">K-9 CANINE</b> - Jednostka z psem śledczym.</p>
                    <p><b class="division-title">Special Response Team</b> - Oddział reagujący na sytuacje wysokiego ryzyka.</p>
                    <p><b class="division-title">Speed Enforcement Unit</b> - Jednostka od pościgów wysoko prędkościowych.</p>
                    <p><b class="division-title">Traffic Service Unit</b> - Wydział Ruchu Drogowego.</p>
                    <p><b class="division-title">Detective Task Unit</b> - Wydział detektywistyczny.</p>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                 <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Wykaz Dywizji WSP</h2>
                 <div id="wsp-divisions-list" class="space-y-6 fira-code text-sm"></div>
            </div>
        </div>

        <div id="ocso-divisions" class="division-content hidden">
             <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
                <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Opis Dywizji OCSO</h2>
                <div class="space-y-4 text-gray-300">
                    <p><b class="division-title">Highway Patrol</b> - Patrol autostradowy, głównie zajmuje się akcjami związanymi z ruchem drogowym.</p>
                    <p><b class="division-title">K-9 CANINE</b> - Jednostka z psem śledczym.</p>
                    <p><b class="division-title">Special Emergency Response Team</b> - Oddział reagujący na sytuacje wysokiego ryzyka.</p>
                    <p><b class="division-title">Special Investigation Unit</b> - Special Investigation Unit (SIU) to wyspecjalizowana jednostka do prowadzenia skomplikowanych lub wrażliwych dochodzeń.</p>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                 <h2 class="text-xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Wykaz Dywizji OCSO</h2>
                 <div id="ocso-divisions-list" class="space-y-6 fira-code text-sm"></div>
            </div>
        </div>
    </main>

    <div id="manage-division-modal" class="modal-backdrop fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 z-50 justify-center items-center">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
            <h3 id="modal-title" class="text-lg font-medium leading-6 text-white mb-4">Zarządzaj Dywizją</h3>
            
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <h4 class="text-md font-semibold text-yellow-400 mb-2">Zarząd</h4>
                    <ul id="modal-leads-list" class="space-y-2"></ul>
                    <div class="mt-4 flex gap-2">
                        <select id="add-lead-select" class="flex-grow bg-gray-700 rounded p-2 text-sm"></select>
                        <button id="add-lead-button" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-lg"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div>
                    <h4 class="text-md font-semibold text-purple-400 mb-2">Dywizja</h4>
                    <ul id="modal-members-list" class="space-y-2"></ul>
                     <div class="mt-4 flex gap-2">
                        <select id="add-member-select" class="flex-grow bg-gray-700 rounded p-2 text-sm"></select>
                        <button id="add-member-button" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2 rounded-lg"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </div>

            <button id="modal-close-button" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <script src="shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userData = await loadSidebarAndUserData('dywizje');
            if (!userData) return;

            const token = localStorage.getItem('mdt-token');
            const wspDivisionsList = document.getElementById('wsp-divisions-list');
            const ocsoDivisionsList = document.getElementById('ocso-divisions-list');

            const modal = document.getElementById('manage-division-modal');
            const modalTitle = document.getElementById('modal-title');
            
            let allOfficers = [];
            let allDivisions = {};
            let selectedDivision = '';
            let currentDepartment = 'WSP';

            async function fetchAllData() {
                try {
                    const [divisionsRes, officersRes] = await Promise.all([
                        fetch('/api/divisions', { headers: { 'Authorization': token } }),
                        fetch('/api/officers', { headers: { 'Authorization': token } })
                    ]);
                    if (!divisionsRes.ok || !officersRes.ok) {
                        throw new Error('Błąd pobierania danych z serwera.');
                    }
                    allDivisions = await divisionsRes.json();
                    allOfficers = (await officersRes.json()).filter(o => o.username !== 'Administrator');
                    renderDivisions();
                } catch(error) {
                    console.error("Błąd w fetchAllData:", error);
                    wspDivisionsList.innerHTML = `<p class="text-red-500">Nie udało się załadować dywizji.</p>`;
                    ocsoDivisionsList.innerHTML = `<p class="text-red-500">Nie udało się załadować dywizji.</p>`;
                }
            }

            function renderDivisions() {
                const divisionsForDept = allDivisions[currentDepartment] || {};
                const listContainer = currentDepartment === 'WSP' ? wspDivisionsList : ocsoDivisionsList;

                if (!listContainer) return; 
                
                listContainer.innerHTML = '';
                const patrolHtml = `<p><b class="division-lead">Dywizja Patrolowa:</b> <span class="division-members">Każdy funkcjonariusz ${currentDepartment}</span></p>`;
                listContainer.innerHTML += `<div>${patrolHtml}</div>`;

                if (Object.keys(divisionsForDept).length === 0) {
                    listContainer.innerHTML += `<p class="text-gray-400 mt-4">Brak zdefiniowanych dywizji dla ${currentDepartment}.</p>`;
                }

                for (const divisionName in divisionsForDept) {
                    const division = divisionsForDept[divisionName];
                    const manageButton = userData.isAdmin ? `<button data-division="${divisionName}" class="manage-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded-lg ml-4">Zarządzaj</button>` : '';
                    
                    let divisionHtml = `
                        <div>
                            <p><b class="division-lead">Zarząd ${divisionName}:</b> <span class="division-members">${division.lead && division.lead.length > 0 ? division.lead.join(' ') : 'Brak'}</span></p>
                            <p><b class="division-lead">Dywizja ${divisionName}:</b> <span class="division-members">${division.members && division.members.length > 0 ? division.members.join(' ') : 'Brak'}</span> ${manageButton}</p>
                        </div>
                    `;
                    listContainer.innerHTML += divisionHtml;
                }
            }
            
            function openManageModal(divisionName) {
                selectedDivision = divisionName;
                const divisionData = allDivisions[currentDepartment][divisionName];
                modalTitle.textContent = `Zarządzaj Dywizją: ${divisionName}`;

                const populateList = (listId, members, type) => {
                    const listEl = document.getElementById(listId);
                    listEl.innerHTML = members.map(name => `
                        <li class="flex justify-between items-center bg-gray-700 p-1 rounded">
                            <span>${name}</span>
                            <button data-name="${name}" data-type="${type}" class="remove-member-btn text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                        </li>
                    `).join('');
                };

                const populateSelect = (selectId, members) => {
                    const selectEl = document.getElementById(selectId);
                    selectEl.innerHTML = '<option value="">Wybierz funkcjonariusza...</option>';
                    allOfficers
                        .filter(o => o.department === currentDepartment && !members.includes(`${o.username} (${o.badge})`))
                        .forEach(o => selectEl.innerHTML += `<option value="${o.username} (${o.badge})">${o.username} (${o.badge})</option>`);
                };

                populateList('modal-leads-list', divisionData.lead, 'lead');
                populateList('modal-members-list', divisionData.members, 'members');
                populateSelect('add-lead-select', [...divisionData.lead, ...divisionData.members]);
                populateSelect('add-member-select', [...divisionData.lead, ...divisionData.members]);
                
                lucide.createIcons();
                modal.classList.add('flex');
            }

            async function updateMember(officerName, memberType, action = 'add') {
                const method = action === 'add' ? 'POST' : 'DELETE';
                const res = await fetch('/api/divisions/members', {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ department: currentDepartment, divisionName: selectedDivision, memberType, officerName })
                });
                if (res.ok) {
                    await fetchAllData();
                    openManageModal(selectedDivision);
                } else {
                    alert('Wystąpił błąd.');
                }
            }

            document.body.addEventListener('click', e => {
                const manageBtn = e.target.closest('.manage-btn');
                if (manageBtn) {
                    openManageModal(manageBtn.dataset.division);
                }
            });

            document.getElementById('modal-close-button').addEventListener('click', () => modal.classList.remove('flex'));
            document.getElementById('add-lead-button').addEventListener('click', () => {
                const officerName = document.getElementById('add-lead-select').value;
                if (officerName) updateMember(officerName, 'lead', 'add');
            });
            document.getElementById('add-member-button').addEventListener('click', () => {
                const officerName = document.getElementById('add-member-select').value;
                if (officerName) updateMember(officerName, 'members', 'add');
            });

            modal.addEventListener('click', e => {
                const removeBtn = e.target.closest('.remove-member-btn');
                if(removeBtn) {
                    updateMember(removeBtn.dataset.name, removeBtn.dataset.type, 'remove');
                }
            });

            document.getElementById('wsp-btn').addEventListener('click', () => {
                currentDepartment = 'WSP';
                document.getElementById('wsp-btn').classList.add('active');
                document.getElementById('ocso-btn').classList.remove('active');
                document.getElementById('wsp-divisions').classList.remove('hidden');
                document.getElementById('ocso-divisions').classList.add('hidden');
                renderDivisions();
            });

            document.getElementById('ocso-btn').addEventListener('click', () => {
                currentDepartment = 'OCSO';
                document.getElementById('ocso-btn').classList.add('active');
                document.getElementById('wsp-btn').classList.remove('active');
                document.getElementById('ocso-divisions').classList.remove('hidden');
                document.getElementById('wsp-divisions').classList.add('hidden');
                renderDivisions();
            });

            fetchAllData();
        });
    </script>
</body>
</html>