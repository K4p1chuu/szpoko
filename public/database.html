<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baza Danych - MDT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style> 
        body { font-family: 'Inter', sans-serif; }
        #search-suggestions { max-height: 200px; }
        .modal-backdrop { display: none; }
        .modal-backdrop.flex { display: flex; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex h-screen">

    <aside id="sidebar-container" class="w-64 bg-gray-800 p-4 flex flex-col min-h-screen flex-shrink-0"></aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <h1 class="text-3xl font-bold text-white mb-6">Baza Danych</h1>
        
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6 relative">
            <div class="flex items-center space-x-4 mb-4">
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="searchType" value="citizen" class="form-radio h-4 w-4 text-blue-600" checked>
                    <span class="ml-2 text-gray-300">Obywatel</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="searchType" value="officer" class="form-radio h-4 w-4 text-blue-600">
                    <span class="ml-2 text-gray-300">Funkcjonariusz</span>
                </label>
            </div>
            <div class="flex space-x-4">
                <input type="text" id="search-input" class="flex-grow bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Zacznij wpisywać Nick RP obywatela...">
                <button id="search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg hidden">Szukaj</button>
            </div>
            <div id="search-suggestions" class="absolute w-full left-0 mt-1 bg-gray-700 border border-gray-600 rounded-md overflow-y-auto z-20 hidden"></div>
        </div>
        
        <div id="citizen-results-container" class="hidden space-y-6">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-white mb-4" id="citizen-name"></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-sm">
                    <div><p class="text-gray-400">ID Discord</p><p id="citizen-discord-id" class="font-mono"></p></div>
                    <div><p class="text-gray-400">Główny nick Discord</p><p id="citizen-main-nick" class="font-semibold"></p></div>
                    <div><p class="text-gray-400">Data dołączenia</p><p id="citizen-join-date" class="font-semibold"></p></div>
                    <div><p class="text-gray-400">Mandaty</p><p id="citizen-ticket-count" class="text-xl font-bold text-amber-400"></p></div>
                    <div><p class="text-gray-400">Areszty</p><p id="citizen-arrest-count" class="text-xl font-bold text-red-400"></p></div>
                    <div><p class="text-gray-400">Pouczenia</p><p id="citizen-warning-count" class="text-xl font-bold text-yellow-400"></p></div>
                </div>
            </div>
            
            <div id="citizen-bolo-status-container" class="hidden"></div>
            
            <div id="citizen-vehicles-container" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-semibold text-white mb-4">Posiadane Pojazdy</h3>
                <div id="citizen-vehicles-list" class="space-y-2"></div>
            </div>

            <div id="citizen-records-tables-container" class="space-y-6"></div>
        </div>
        
        <div id="officer-results-container" class="hidden space-y-6"></div>

        <div id="message-container" class="text-center py-10">
            <p class="text-gray-500">Wybierz typ i rozpocznij wyszukiwanie.</p>
        </div>
    </main>
    
    <div id="confirm-modal" class="modal-backdrop fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 z-50 justify-center items-center">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <h3 id="confirm-modal-title" class="text-lg font-medium leading-6 text-white">Potwierdź akcję</h3>
            <p id="confirm-modal-text" class="mt-2 text-sm text-gray-400">Czy na pewno chcesz kontynuować?</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" id="confirm-cancel-button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Anuluj</button>
                <button type="button" id="confirm-danger-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Potwierdź</button>
            </div>
        </div>
    </div>
    
    <script src="shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userData = await loadSidebarAndUserData('database');
            if(!userData) return;

            const token = localStorage.getItem('mdt-token');
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const suggestionsContainer = document.getElementById('search-suggestions');
            const citizenResultsContainer = document.getElementById('citizen-results-container');
            const officerResultsContainer = document.getElementById('officer-results-container');
            const messageContainer = document.getElementById('message-container');
            const searchTypeRadios = document.querySelectorAll('input[name="searchType"]');
            
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmCancelButton = document.getElementById('confirm-cancel-button');
            const confirmDangerButton = document.getElementById('confirm-danger-button');
            let actionToConfirm = null;

            let allCitizens = [];
            let currentSearchType = 'citizen';

            function updateSearchUI() {
                currentSearchType = document.querySelector('input[name="searchType"]:checked').value;
                citizenResultsContainer.classList.add('hidden');
                officerResultsContainer.classList.add('hidden');
                messageContainer.innerHTML = '<p class="text-gray-500">Wybierz typ i rozpocznij wyszukiwanie.</p>';
                searchInput.value = '';

                if (currentSearchType === 'citizen') {
                    searchInput.placeholder = "Zacznij wpisywać Nick RP obywatela...";
                    searchButton.classList.add('hidden');
                    searchInput.removeEventListener('keydown', handleOfficerSearchKeydown);
                } else {
                    searchInput.placeholder = "Wpisz numer odznaki funkcjonariusza...";
                    searchButton.classList.remove('hidden');
                    suggestionsContainer.classList.add('hidden');
                    searchInput.addEventListener('keydown', handleOfficerSearchKeydown);
                }
            }
            
            async function loadAllCitizens() {
                try {
                    const response = await fetch('/api/citizens', { headers: { 'Authorization': token } });
                    if (!response.ok) throw new Error('Błąd odpowiedzi serwera');
                    allCitizens = await response.json();
                } catch (error) {
                    console.error("Błąd ładowania obywateli:", error);
                }
            }

            async function displayCitizenProfile(discordId) {
                officerResultsContainer.classList.add('hidden');
                citizenResultsContainer.classList.add('hidden');
                messageContainer.innerHTML = '<p class="text-gray-500">Wyszukiwanie...</p>';
                try {
                    const response = await fetch(`/api/citizen/${discordId}`, { headers: { 'Authorization': token } });
                    if (!response.ok) throw new Error('Nie znaleziono obywatela');
                    const citizenData = await response.json();
                    
                    const suspendedLicenseTag = citizenData.licenseSuspended ? '<span class="ml-2 text-xs font-bold text-red-400 bg-red-900/50 px-2 py-1 rounded-full">ZABRANE PRAWO JAZDY</span>' : '';
                    document.getElementById('citizen-name').innerHTML = `${citizenData.name} ${suspendedLicenseTag}`;

                    document.getElementById('citizen-discord-id').textContent = citizenData.discordId;
                    document.getElementById('citizen-main-nick').textContent = citizenData.globalName || 'Brak danych';
                    const joinDate = citizenData.joinedTimestamp ? new Date(citizenData.joinedTimestamp * 1000).toLocaleDateString('pl-PL') : 'Brak danych';
                    document.getElementById('citizen-join-date').textContent = joinDate;
                    document.getElementById('citizen-ticket-count').textContent = citizenData.ticketCount || 0;
                    document.getElementById('citizen-arrest-count').textContent = citizenData.arrestCount || 0;
                    document.getElementById('citizen-warning-count').textContent = citizenData.warningCount || 0;

                    const boloContainer = document.getElementById('citizen-bolo-status-container');
                    if (citizenData.wantedStatus && citizenData.wantedStatus.length > 0) {
                        let boloHtml = `
                            <div class="bg-red-800/50 border-2 border-red-500 p-4 rounded-lg shadow-lg">
                                <h3 class="text-xl font-bold text-red-300 mb-3 flex items-center">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 mr-3"></i> OSOBA POSZUKIWANA
                                </h3>
                                <div class="space-y-2">
                        `;
                        citizenData.wantedStatus.forEach(bolo => {
                             boloHtml += `<p class="text-red-200"><strong>Powód:</strong> ${bolo.details.powod || 'Nie podano'}</p>`;
                        });
                        boloHtml += `</div></div>`;
                        boloContainer.innerHTML = boloHtml;
                        boloContainer.classList.remove('hidden');
                        lucide.createIcons();
                    } else {
                        boloContainer.innerHTML = '';
                        boloContainer.classList.add('hidden');
                    }
                    
                    const vehiclesList = document.getElementById('citizen-vehicles-list');
                    if (citizenData.vehicles && citizenData.vehicles.length > 0) {
                        vehiclesList.innerHTML = citizenData.vehicles.map(v => {
                            const impoundedStatus = v.isImpounded ? '<span class="ml-2 text-xs font-bold text-yellow-400 bg-yellow-900/50 px-2 py-1 rounded-full">ZAREKWIROWANY</span>' : '';
                            return `<div class="bg-gray-900 p-2 rounded-md text-sm"><b>${v.plate}</b> - ${v.status} ${impoundedStatus}</div>`
                        }).join('');
                    } else {
                        vehiclesList.innerHTML = '<p class="text-gray-500 text-sm">Brak zarejestrowanych pojazdów.</p>';
                    }

                    renderRecordsTables(citizenData.records || [], citizenData.discordId, document.getElementById('citizen-records-tables-container'));

                    citizenResultsContainer.classList.remove('hidden');
                    messageContainer.innerHTML = '';

                } catch (error) {
                    console.error("Błąd wyświetlania profilu obywatela:", error);
                    messageContainer.innerHTML = `<p class="text-red-500">${error.message}</p>`;
                }
            }
            
            function renderRecordsTables(records, id, container) {
                container.innerHTML = ''; 

                const recordTypes = {
                    mandat: { title: 'Kartoteka Mandatów' },
                    pouczenie: { title: 'Kartoteka Pouczeń' },
                    areszt: { title: 'Kartoteka Aresztowań' }
                };

                Object.keys(recordTypes).forEach(type => {
                    const typedRecords = records.filter(r => r.reportType === type);
                    const config = recordTypes[type];

                    let tableHTML = `
                        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-white mb-4">${config.title}</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm text-left text-gray-300">
                                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">`;
                    
                    if (type === 'mandat') tableHTML += `<tr><th class="px-6 py-3">Data</th><th class="px-6 py-3">Wystawiający</th><th class="px-6 py-3">Kwota</th><th class="px-6 py-3">Zarzuty</th>${(userData.isAdmin || userData.badge === '101') ? '<th class="px-6 py-3">Akcje</th>' : ''}</tr></thead><tbody>`;
                    else if (type === 'pouczenie') tableHTML += `<tr><th class="px-6 py-3">Data</th><th class="px-6 py-3">Wystawiający</th><th class="px-6 py-3">Zarzuty</th>${(userData.isAdmin || userData.badge === '101') ? '<th class="px-6 py-3">Akcje</th>' : ''}</tr></thead><tbody>`;
                    else if (type === 'areszt') tableHTML += `<tr><th class="px-6 py-3">Data</th><th class="px-6 py-3">Wystawiający</th><th class="px-6 py-3">Wyrok</th><th class="px-6 py-3">Zarzuty</th>${(userData.isAdmin || userData.badge === '101') ? '<th class="px-6 py-3">Akcje</th>' : ''}</tr></thead><tbody>`;

                    if (typedRecords.length === 0) {
                        tableHTML += `<tr><td colspan="5" class="px-6 py-4 text-center">Brak wpisów w kartotece.</td></tr>`;
                    } else {
                        typedRecords.forEach(record => {
                            const charges = (record.charges || []).map(c => c.name).join(', ');
                            const deleteButton = (userData.isAdmin || userData.badge === '101') ? `<td class="px-6 py-4"><button data-record-id="${record.id}" data-citizen-id="${record.civilianDiscordId}" class="delete-record-btn text-red-500 hover:underline">Usuń</button></td>` : '';
                            
                            tableHTML += `<tr class="hover:bg-gray-700">`;
                            if (type === 'mandat') tableHTML += `<td class="px-6 py-4">${new Date(record.issueDate).toLocaleDateString('pl-PL')}</td><td class="px-6 py-4">${record.author}</td><td class="px-6 py-4 font-semibold text-green-400">$${record.totalFine || 0}</td><td class="px-6 py-4 text-xs">${charges}</td>${deleteButton}`;
                            else if (type === 'pouczenie') tableHTML += `<td class="px-6 py-4">${new Date(record.issueDate).toLocaleDateString('pl-PL')}</td><td class="px-6 py-4">${record.author}</td><td class="px-6 py-4 text-xs">${charges}</td>${deleteButton}`;
                            else if (type === 'areszt') tableHTML += `<td class="px-6 py-4">${new Date(record.issueDate).toLocaleDateString('pl-PL')}</td><td class="px-6 py-4">${record.author}</td><td class="px-6 py-4 font-semibold text-red-400">${record.finalSentence} minut</td><td class="px-6 py-4 text-xs">${charges}</td>${deleteButton}`;
                            tableHTML += `</tr>`;
                        });
                    }
                    
                    tableHTML += `</tbody></table></div></div>`;
                    container.innerHTML += tableHTML;
                });
                
                container.addEventListener('click', handleDeleteClick);
            }
            
            function handleDeleteClick(event) {
                if (event.target.classList.contains('delete-record-btn')) {
                    const recordId = event.target.dataset.recordId;
                    const citizenId = event.target.dataset.citizenId;
                    showConfirmModal(`Czy na pewno chcesz usunąć ten wpis? Tej operacji nie można cofnąć.`, async () => {
                         try {
                            const response = await fetch(`/api/records/${citizenId}/${recordId}`, { 
                                method: 'DELETE',
                                headers: { 'Authorization': token }
                            });
                             if (!response.ok) {
                                const err = await response.json();
                                throw new Error(err.message || 'Błąd serwera');
                            }
                            if (currentSearchType === 'citizen') {
                                displayCitizenProfile(citizenId);
                            } else {
                                performSearch();
                            }
                        } catch (error) {
                             messageContainer.innerHTML = `<p class="text-red-500">Błąd: ${error.message}</p>`;
                        }
                    });
                }
            }

            function showConfirmModal(text, onConfirm) {
                confirmModalText.textContent = text;
                actionToConfirm = onConfirm;
                confirmModal.classList.add('flex');
            }

            confirmCancelButton.addEventListener('click', () => {
                confirmModal.classList.remove('flex');
                actionToConfirm = null;
            });

            confirmDangerButton.addEventListener('click', () => {
                if (typeof actionToConfirm === 'function') {
                    actionToConfirm();
                }
                confirmModal.classList.remove('flex');
                actionToConfirm = null;
            });

            function displayOfficerProfile(data) {
                officerResultsContainer.innerHTML = '';
                
                const joinedDate = data.joinedAt ? new Date(data.joinedAt).toLocaleDateString('pl-PL') : 'Brak danych';

                const profileHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-semibold text-white mb-4">[${data.badge}] ${data.username}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-sm">
                             <div><p class="text-gray-400">Ranga</p><p class="font-semibold">${data.rank}</p></div>
                             <div><p class="text-gray-400">ID Roblox</p><p class="font-mono">${data.robloxId || 'N/A'}</p></div>
                             <div><p class="text-gray-400">Nick Discord</p><p>${data.discordNick || 'N/A'}</p></div>
                             <div><p class="text-gray-400">W WSP od</p><p>${joinedDate}</p></div>
                             <div><p class="text-gray-400">Mandaty</p><p class="text-xl font-bold text-amber-400">${data.stats.tickets.count}</p></div>
                             <div><p class="text-gray-400">Areszty</p><p class="text-xl font-bold text-red-400">${data.stats.arrests.count}</p></div>
                             <div><p class="text-gray-400">Pouczenia</p><p class="text-xl font-bold text-yellow-400">${data.stats.warnings.count}</p></div>
                             <div><p class="text-gray-400">Łączna kwota</p><p class="text-xl font-bold text-green-400">$${data.stats.totalValue}</p></div>
                        </div>
                    </div>
                `;
                officerResultsContainer.innerHTML = profileHTML;
                renderRecordsTables(data.records || [], data.discordId, officerResultsContainer);
            }

            async function performSearch() {
                const query = searchInput.value;
                if (!query) return;

                citizenResultsContainer.classList.add('hidden');
                officerResultsContainer.classList.add('hidden');
                messageContainer.innerHTML = '<p class="text-gray-500">Wyszukiwanie...</p>';

                if (currentSearchType === 'officer') {
                    try {
                        const response = await fetch(`/api/officer/badge/${query}`, { headers: { 'Authorization': token } });
                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.message || 'Nie znaleziono funkcjonariusza');
                        }
                        const officerData = await response.json();
                        displayOfficerProfile(officerData);
                        officerResultsContainer.classList.remove('hidden');
                        messageContainer.innerHTML = '';
                    } catch (error) {
                         messageContainer.innerHTML = `<p class="text-red-500">${error.message}</p>`;
                    }
                }
            }
            
            function handleOfficerSearchKeydown(e) {
                if(e.key === 'Enter') {
                    performSearch();
                }
            }

            searchButton.addEventListener('click', performSearch);
            searchTypeRadios.forEach(radio => radio.addEventListener('change', updateSearchUI));
            
            searchInput.addEventListener('input', () => {
                if (currentSearchType !== 'citizen') return;
                const query = searchInput.value.toLowerCase();
                if (query.length < 2) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                const filtered = allCitizens.filter(c => c.name && c.name.toLowerCase().includes(query));
                suggestionsContainer.innerHTML = '';

                if (filtered.length > 0) {
                    filtered.slice(0, 10).forEach(citizen => {
                        // Dodanie czerwonej etykietki do sugestii
                        const suspendedLicenseTag = citizen.licenseSuspended ? '<span class="ml-2 text-xs font-bold text-red-400">ZABRANE</span>' : '';
                        const div = document.createElement('div');
                        div.className = 'p-2 hover:bg-gray-600 cursor-pointer text-sm';
                        div.innerHTML = `${citizen.name} (${citizen.discordId}) ${suspendedLicenseTag}`;
                        div.addEventListener('click', () => {
                            searchInput.value = '';
                            suggestionsContainer.classList.add('hidden');
                            displayCitizenProfile(citizen.discordId);
                        });
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            updateSearchUI();
            await loadAllCitizens();
        });
    </script>
</body>
</html>