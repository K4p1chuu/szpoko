<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Główny - MDT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-900 text-gray-200 flex h-screen">

    <aside id="sidebar-container" class="w-64 bg-gray-800 p-4 flex flex-col min-h-screen flex-shrink-0"></aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <h1 class="text-3xl font-bold text-white mb-6">Panel Główny</h1>
        <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold text-cyan-300 mb-3 flex items-center">
                        <i data-lucide="users" class="w-5 h-5 mr-2"></i>
                        Lista Funkcjonariuszy
                    </h2>
                    <div id="officers-list-container" class="text-sm space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">Wczytywanie listy funkcjonariuszy...</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold text-amber-300 mb-2 flex items-center">
                        <i data-lucide="megaphone" class="w-5 h-5 mr-2"></i>
                        Tablica Ogłoszeń Departamentów
                    </h2>
                    <div id="announcements-list" class="text-sm space-y-3 max-h-48 overflow-y-auto"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold text-blue-300 mb-2 flex items-center">
                        <i data-lucide="book-user" class="w-5 h-5 mr-2"></i>
                        Dziennik Służby
                    </h2>
                    <div id="duty-log-status"></div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg h-full flex flex-col">
                    <h2 class="text-lg font-semibold text-green-300 mb-2 flex items-center">
                        <i data-lucide="notebook-pen" class="w-5 h-5 mr-2"></i>
                        Osobisty Notatnik
                    </h2>
                    <textarea id="notepad" class="flex-grow bg-gray-900 text-gray-300 text-sm rounded-md p-2 w-full resize-none" placeholder="Twoje notatki..."></textarea>
                    <button id="save-note-btn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded-lg w-full">Zapisz Notatki</button>
                </div>
            </div>

        </div>
    </main>
    
    <script src="shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userData = await loadSidebarAndUserData('dashboard');
            if(!userData) return;

            const token = localStorage.getItem('mdt-token');
            const announcementsList = document.getElementById('announcements-list');
            const notepad = document.getElementById('notepad');
            const saveNoteBtn = document.getElementById('save-note-btn');
            const dutyLogStatus = document.getElementById('duty-log-status');
            // NOWY ELEMENT
            const officersContainer = document.getElementById('officers-list-container');

            // --- NOWA FUNKCJA DO POBIERANIA I WYŚWIETLANIA FUNKCJONARIUSZY ---
            async function fetchAndDisplayOfficers() {
                try {
                    const response = await fetch('/api/officers/stats', {
                        headers: { 'Authorization': token }
                    });
                    if (!response.ok) throw new Error('Nie udało się pobrać danych funkcjonariuszy');
                    
                    const officers = await response.json();
                    
                    officersContainer.innerHTML = ''; // Wyczyść kontener
                    
                    if (officers.length > 0) {
                        officers.forEach(officer => {
                            if (officer.username === 'Administrator') return; // Pomiń admina

                            const officerDiv = document.createElement('div');
                            officerDiv.className = 'bg-gray-900 p-2 rounded-md flex justify-between items-center';
                            
                            const onLeaveBadge = officer.onLeave ? '<span class="text-xs bg-yellow-600 text-white px-2 py-1 rounded-full">Na urlopie</span>' : '';

                            officerDiv.innerHTML = `
                                <div>
                                    <p class="font-semibold">${officer.username} <span class="text-gray-400 text-xs">[#${officer.badge}]</span></p>
                                    <p class="text-xs text-gray-400">${officer.rank} - ${officer.department || 'Brak'}</p>
                                </div>
                                <div>
                                    ${onLeaveBadge}
                                </div>
                            `;
                            officersContainer.appendChild(officerDiv);
                        });
                    } else {
                        officersContainer.innerHTML = '<p class="text-gray-500">Nie znaleziono funkcjonariuszy.</p>';
                    }
                } catch (error) {
                    console.error("Błąd ładowania funkcjonariuszy:", error);
                    officersContainer.innerHTML = '<p class="text-red-500">Błąd ładowania listy funkcjonariuszy.</p>';
                }
            }
            
            function fetchAnnouncements() {
                fetch('/api/announcements', { headers: { 'Authorization': token } })
                    .then(res => res.json())
                    .then(data => {
                        announcementsList.innerHTML = '';
                        if (data && data.length > 0) {
                             announcementsList.innerHTML = data.map(a => `
                                <div class="bg-gray-900 p-2 rounded-md">
                                    <p class="font-semibold">${a.title}</p>
                                    <p class="text-xs text-gray-400">Dodane przez: ${a.author}</p>
                                </div>
                            `).join('');
                        } else {
                            announcementsList.innerHTML = '<p class="text-gray-500">Brak aktywnych ogłoszeń.</p>';
                        }
                    });
            }
            
            fetch('/api/notes', { headers: { 'Authorization': token } }).then(res => res.json()).then(data => notepad.value = data.note);

            saveNoteBtn.addEventListener('click', () => {
                fetch('/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ note: notepad.value })
                }).then(res => {
                    if (res.ok) {
                        saveNoteBtn.textContent = 'Zapisano!';
                        setTimeout(() => { saveNoteBtn.textContent = 'Zapisz Notatki'; }, 2000);
                    }
                });
            });
            
            // Inicjalizacja
            fetchAndDisplayOfficers(); // Wywołaj nową funkcję
            fetchAnnouncements();
            lucide.createIcons();
        });
    </script>
</body>
</html>